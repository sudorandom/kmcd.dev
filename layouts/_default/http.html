{{ define "main" }}

<main class="post">
    {{if not .Params.hideTitle }}
        <h1 class="post-title">{{ with .Params.TitleIcon}}<i class="fa-solid {{ . }}"></i> {{end}}<a href="{{ .Permalink }}">{{ .Title | markdownify }}</a></h1>
        {{ with .Params.Subtitle }}<div class="post-excerpt">{{ . }}</div>{{ end }}
    {{ end }}

    <noscript>
        This page only works when javascript is enabled
    </noscript>
    <div class="main-wrapper">
        <div class="main-box">
            <article>
                <div id="manual-notice" hidden>
                    <p>
                        <i><strong>Note that the version of HTTP being used by your browser is actually different than the one showed on this page. You actually connected with <span class="http-version">???</span>. <a href="/http/">Go back to the real page.</a></strong></i>
                    </p>
                </div>

                <div class="post-content" id="http10" hidden>
                    <h2>You have downloaded this page using&nbsp;<strong>HTTP/1.0</strong></h2>
                    <p>
                        This version is not that common, so you likely used the link below to get here or you are a robot. <i class="fa-solid fa-robot"></i>
                    </p>
                    <p>
                        HTTP/1.0 Introduced status codes, headers for content negotiation, and support for various media types.
                    </p>
                    <h3>Limitations</h3>
                    <p>
                        Each request/response required a new TCP connection, leading to overhead and performance issues.
                    </p>
                    <h3>RFCs</h3>
                    <p>
                        <ul>
                            <li><a href="https://www.rfc-editor.org/rfc/rfc1945" target="_blank">RFC 1945</a> <br /></li>
                        </ul>
                    </p>
                </div>

                <div class="post-content" id="http11" hidden>
                    <h2>You have downloaded this page with&nbsp;<strong>HTTP/1.1</strong></h2>
                    <p>
                        HTTP/1.1 introduced persistent connections (keeping a TCP connection open for multiple requests/responses), chunked transfer encoding, virtual hosting, and caching mechanisms.
                    </p>
                    <h3>Limitations</h3>
                    <p>
                        HTTP/1.1 has limited support for concurrency and requires opening multiple connections to perform requests in parallel. It is also still text-based so the overhead for requests is rather large. Headers also cannot be compressed.
                    </p>
                    <h3>RFCs</h3>
                    <ul>
                        <li><a href="https://www.rfc-editor.org/rfc/rfc2616" target="_blank">RFC 2616 (obsoleted)</a></li>
                        <li><a href="https://www.rfc-editor.org/rfc/rfc7230" target="_blank">RFC 7230</a> - <a href="https://www.rfc-editor.org/rfc/rfc7235" target="_blank">RFC 7235</a></li>
                    </ul>
                </div>

                <div class="post-content" id="http2" hidden>
                    <h2>You have downloaded this page with&nbsp;<strong>HTTP/2</strong></h2>
                    <p>
                        Note that if you refresh this page there's a chance that you will connect with HTTP/3 instead. This is caused by the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Alt-Svc">Alt-Svc header</a> or the <a href="https://blog.cloudflare.com/speeding-up-https-and-http-3-negotiation-with-dns">HTTPS DNS Entry</a> being read by your browser after the first request to the page is already in progress or completed.
                    </p>
                    <p>
                        HTTP/2 introduced binary framing, header compression (HPACK), multiplexing (multiple requests/responses concurrently over a single connection), and server push.
                    </p>
                    <h3>Limitations</h3>
                    <p>
                        HTTP/2 still relies on TCP, which can suffer from head-of-line blocking and performance issues on lossy networks.
                    </p>
                    <h3>RFCs</h3>
                    <ul>
                        <li><a href="https://www.rfc-editor.org/rfc/rfc7540" target="_blank">RFC 7540</a></li>
                    </ul>
                </div>

                <div class="post-content" id="http3" hidden>
                    <h2>You have downloaded this page with&nbsp;<strong>HTTP/3</strong></h2>
                    <p>
                        Congratulations! You are using the latest HTTP version.
                    </p>
                    <p>
                        HTTP/3 uses QUIC as its transport protocol which is built on UDP, providing faster connection establishment, improved congestion control, and multiplexed streams that are independently reliable.
                    </p>
                    <h3>Limitations</h3>
                    <p>
                        HTTP/3 is relatively new, so adoption is still growing. However, <a href="https://caniuse.com/http3" target="_blank">all major browsers support HTTP/3</a> so for the web, adoption is mostly held up with server support.
                    </p>
                    <h3>RFCs</h3>
                    <ul>
                        <li><a href="https://www.rfc-editor.org/rfc/rfc9114" target="_blank">RFC 9114</a></li>
                    </ul>
                </div>

                <div class="post-content" id="httpunknown" hidden>
                    <h2>You have downloaded this page with&nbsp;<strong><span class="http-version">???</span></strong></h2>
                    <p>
                        This is awkward. You appear to be using a version of HTTP that this page doesn't know about! It could be that the HTTP version detection is broken, a new version was released and I just haven't updated this page yet, or you messed with the query parameter that I use to test this page. Regardless, congrats for finding this!
                    </p>
                </div>

                <div class="post-content">
                    {{ .Content }}
                </div>
            </article>
        </div>
    </div>
</main>

<script>
async function getHTTPVersion() {
    try {
        const resp = await fetch(document.location);
        if (!resp.ok) {
            throw new Error(`resp status: ${response.status}`);
        }
        // the server is configured to always return a header containing the http version used on the edge.
        // We will use that unless there's a query param set for debugging.
        return resp.headers.get('x-kmcd-http-request-version')
    } catch (error) {
        console.error(error.message);
    }
}

getHTTPVersion().then((httpVersion) => {
    if (!httpVersion) {
        httpVersion = "???"
    }
    const searchParams = new URLSearchParams(window.location.search);
    if (searchParams.has('version')) {
        if (searchParams.get('version')) {
            for (elem of document.getElementsByClassName("http-version")) {
                elem.innerHTML = httpVersion
            }
            document.getElementById("manual-notice").removeAttribute("hidden");
        }
        httpVersion = searchParams.get('version');
    }

    switch (httpVersion) {
    case 'HTTP/1.0':
        document.getElementById("http10").removeAttribute("hidden");
        break;
    case 'HTTP/1.1':
        document.getElementById("http11").removeAttribute("hidden");
        break;
    case 'HTTP/2':
        document.getElementById("http2").removeAttribute("hidden");
        break;
    case 'HTTP/3':
        document.getElementById("http3").removeAttribute("hidden");
        break;
    default:
        document.getElementById("httpunknown").removeAttribute("hidden");
    }
})
</script>

{{ end }}
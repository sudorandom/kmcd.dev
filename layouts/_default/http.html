<!DOCTYPE html>
<html lang="{{ .Site.Language }}">
    <head>
        {{ partial "head.html" . }}
    </head>
<body>
    <div class="container">
        <header class="header">
            <nav class="nav">
                <div class="nav-left">
                    <a class="nav-item" href="{{ .Site.BaseURL }}"><i class="fa-solid fa-arrow-left"></i> Back to kmcd.dev</a>
                </div>
            </nav>
        </header>
        <main class="post">

    <div class="main-wrapper">
        <div class="main-box">
            <article>
                <div class="post-content">
                <!-- HTTP Version Detection Results - Dynamically Populated -->
                <div id="loading-state" hidden>
                    <div style="background-color: #2a2a2a; border: 2px solid #888888; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                        <div class="spinner" style="margin: 0 auto 1rem auto;"></div>
                        <h2 style="margin: 0; font-size: 1.8rem; color: #888888;">Detecting HTTP Version...</h2>
                        <p style="margin: 0.5rem 0 0 0; color: #cccccc;">Please wait while we analyze your connection.</p>
                    </div>
                </div>
                <div id="http10-header" hidden>
                    <div style="background-color: #2a1f1f; border: 2px solid #ff6b6b; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                        <h2 style="margin: 0; font-size: 1.8rem; color: #ff6b6b;">üêå You are using <a href="#http10" style="color: #ff6b6b; text-decoration: underline; margin-left:10px">HTTP/1.0</a></h2>
                        <p style="margin: 0.5rem 0 0 0; color: #cccccc;">The original HTTP protocol from 1996</p>
                    </div>
                </div>

                <div id="http11-header" hidden>
                    <div style="background-color: #2a241f; border: 2px solid #ffa726; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                        <h2 style="margin: 0; font-size: 1.8rem; color: #ffa726;">üì° You are using <a href="#http11" style="color: #ffa726; text-decoration: underline; margin-left:10px">HTTP/1.1</a></h2>
                        <p style="margin: 0.5rem 0 0 0; color: #cccccc;">The most widely used HTTP version</p>
                    </div>
                </div>

                <div id="http2-header" hidden>
                    <div style="background-color: #1f2328; border: 2px solid #42a5f5; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                        <h2 style="margin: 0; font-size: 1.8rem; color: #42a5f5;">üöÄ You are using <a href="#http2" style="color: #42a5f5; text-decoration: underline; margin-left:10px">HTTP/2</a></h2>
                        <p style="margin: 0.5rem 0 0 0; color: #cccccc;">Modern binary protocol with multiplexing</p>
                    </div>
                    <div style="background-color: #1e2a35; border-left: 4px solid #42a5f5; padding: 1rem; margin-bottom: 1rem;">
                        <p style="margin: 0; color: #cccccc;">
                            <strong style="color: #42a5f5;">üí° Dynamic Tip:</strong> If you refresh this page, there's a chance you might connect with HTTP/3 instead! This is caused by the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Alt-Svc" style="color: #42a5f5;">Alt-Svc header</a> or the <a href="https://blog.cloudflare.com/speeding-up-https-and-http-3-negotiation-with-dns" style="color: #42a5f5;">HTTPS DNS Entry</a> being read by your browser.
                        </p>
                    </div>
                </div>

                <div id="http3-header" hidden>
                    <div style="background-color: #1f2a1f; border: 2px solid #66bb6a; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                        <h2 style="margin: 0; font-size: 1.8rem; color: #66bb6a;">‚ú® You are using <a href="#http3" style="color: #66bb6a; text-decoration: underline; margin-left:10px">HTTP/3</a></h2>
                        <p style="margin: 0.5rem 0 0 0; color: #cccccc;">Congratulations! You're using the latest HTTP version with QUIC</p>
                    </div>
                    <div style="background-color: #1e352a; border-left: 4px solid #66bb6a; padding: 1rem; margin-bottom: 1rem;">
                        <p style="margin: 0; color: #cccccc;">
                            <strong style="color: #66bb6a;">üéâ Cutting Edge:</strong> You're experiencing the fastest HTTP protocol available, built on UDP with QUIC for optimal performance!
                        </p>
                    </div>
                </div>

                <div id="httpunknown-header" hidden>
                    <div style="background-color: #2a1f2a; border: 2px solid #ab47bc; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;">
                        <h2 style="margin: 0; font-size: 1.8rem; color: #ab47bc;">‚ùì You are using <span class="data-http-version" style="color: #ab47bc; margin-left:10px">???</span></h2>
                        <p style="margin: 0.5rem 0 0 0; color: #cccccc;">Unknown or custom HTTP version detected</p>
                    </div>
                    <div style="background-color: #2a1f35; border-left: 4px solid #ab47bc; padding: 1rem; margin-bottom: 1rem;">
                        <p style="margin: 0; color: #cccccc;">
                            <strong style="color: #ab47bc;">ü§î Mystery Protocol:</strong> This is awkward! You appear to be using a version of HTTP that this page doesn't recognize. It could be that the detection is broken, a new version was released, or you're testing with custom parameters. Regardless, congrats for finding this edge case!
                        </p>
                    </div>
                </div>

                <!-- Dynamic indicator -->
                <div id="dynamic-indicator" hidden style="background-color: #1f2835; border-left: 4px solid #42a5f5; padding: 1rem; margin-bottom: 1rem;">
                    <p style="margin: 0; color: #cccccc;"><strong style="color: #42a5f5;">üîÑ This content is dynamically generated</strong> based on your actual HTTP connection. Try refreshing the page or opening it in different browsers to see how the protocol varies!</p>
                </div>
                </div>
            </article>
        </div>
    </div>

    <div class="main-wrapper">
        <div class="main-box" style="background-color: #1f2835; border: 2px solid #42a5f5; border-radius: 8px;">
            <h3 id="http11" style="color: #42a5f5; margin-top: 0;">üìä More Info</h3>
            <div id="clientDataWrapper" hidden>
                <p style="color: #cccccc;">By the way, here is more information that is revealed about you from the request your browser made:</p>

                <div id="http3-retry-note" hidden style="background-color: #1e2a35; border-left: 4px solid #42a5f5; padding: 1rem; margin-bottom: 1rem;">
                    <p style="margin: 0; color: #cccccc;">
                        <strong style="color: #42a5f5;">üí° Fun Fact:</strong> It took multiple requests for your browser to connect with HTTP/3. This is common as browsers often discover HTTP/3 support via headers like <code>Alt-Svc</code> on the first few connections.
                    </p>
                </div>

                <table style="color: #cccccc;">
                    <tr>
                        <th style="color: #42a5f5;">HTTP Version</th>
                        <td><span id="data-http-version" class="emphasized-text"></span></td>
                    </tr>
                    <tr>
                        <th style="color: #42a5f5;">IP Address</th>
                        <td><span id="data-ip"></span></td>
                    </tr>
                    <tr>
                        <th style="color: #42a5f5;">ASN <a href="https://en.wikipedia.org/wiki/Autonomous_system_(Internet)" target="_blank" style="color: #42a5f5;">(?)</a></th>
                        <td><span id="data-asn"></span></td>
                    </tr>
                    <tr>
                        <th style="color: #42a5f5;">City</th>
                        <td><span id="data-city"></span></td>
                    </tr>
                    <tr>
                        <th style="color: #42a5f5;">Postal Code</th>
                        <td><span id="data-postal-code"></span></td>
                    </tr>
                    <tr>
                        <th style="color: #42a5f5;">Country</th>
                        <td><span id="data-country"></span></td>
                    </tr>
                    <tr>
                        <th style="color: #42a5f5;">Continent</th>
                        <td><span id="data-continent"></span></td>
                    </tr>
                    <tr>
                        <th style="color: #42a5f5;">Geo Coordinates</th>
                        <td><span id="data-geo"></span></td>
                    </tr>
                    <tr>
                        <th style="color: #42a5f5;">Time Zone</th>
                        <td><span id="data-tz"></span></td>
                    </tr>
                    <tr>
                        <th style="color: #42a5f5;">User Agent</th>
                        <td><span id="data-useragent"></span></td>
                    </tr>
                </table>
            </div>

            {{ .Content }}
        </div>
    </div>

    <div class="main-wrapper">
        <div class="main-box" style="background-color: #2a2a2a; border: 2px solid #888888; border-radius: 8px;">
            <h3 id="http09" style="color: #888888; margin-top: 0;">üìú HTTP/0.9</h3>
            <p style="color: #cccccc;">
                The simplest protocol, HTTP/0.9, had no headers, status codes, or even different request methods. A request was a single line, and the server's response was just the HTML file.
            </p>
            <ul>
                <li><a href="https://http.dev/0.9" target="_blank" style="color: #ff6b6b;">http.dev/0.9</a></li>
            </ul>
        </div>
    </div>

    <div class="main-wrapper">
        <div class="main-box" style="background-color: #2a1f1f; border: 2px solid #ff6b6b; border-radius: 8px;">
            <h3 id="http10" style="color: #ff6b6b; margin-top: 0;">üêå HTTP/1.0</h3>
            <p style="color: #cccccc;">
                This version brought many of the features we recognize today, including request methods (like GET and POST), HTTP headers for passing metadata, and status codes to indicate the outcome of a request.
            </p>
            <p style="color: #cccccc;">
                However, it required a new TCP connection for every single request, which was inefficient and slow.
            </p>
            <ul>
                <li><a href="https://http.dev/1.0" target="_blank" style="color: #ff6b6b;">http.dev/1.0</a></li>
                <li><a href="https://www.rfc-editor.org/rfc/rfc1945" target="_blank" style="color: #ff6b6b;">RFC 1945</a></li>
            </ul>
        </div>
    </div>

    <div class="main-wrapper">
        <div class="main-box" style="background-color: #2a241f; border: 2px solid #ffa726; border-radius: 8px;">
            <h3 id="http11" style="color: #ffa726; margin-top: 0;">üì° HTTP/1.1</h3>
            <p style="color: #cccccc;">
                HTTP/1.1 solved the connection problem by introducing persistent connections, allowing multiple requests to be sent over a single TCP connection. It also added chunked encoding, which allows a response to be sent in pieces.
            </p>
            <p style="color: #cccccc;">
                While a huge improvement, it still suffered from head-of-line blocking, where a slow request could hold up all the requests behind it.
            </p>
            <ul>
                <li><a href="https://http.dev/1.1" target="_blank" style="color: #ffa726;">http.dev/1.1</a></li>
                <li><a href="https://www.rfc-editor.org/rfc/rfc2616" target="_blank" style="color: #ffa726;">RFC 2616 (obsoleted)</a></li>
                <li><a href="https://www.rfc-editor.org/rfc/rfc7230" target="_blank" style="color: #ffa726;">RFC 7230</a> - <a href="https://www.rfc-editor.org/rfc/rfc7235" target="_blank" style="color: #ffa726;">RFC 7235</a></li>
            </ul>
        </div>
    </div>

    <div class="main-wrapper">
        <div class="main-box" style="background-color: #1f2328; border: 2px solid #42a5f5; border-radius: 8px;">
            <h3 id="http2" style="color: #42a5f5; margin-top: 0;">üöÄ HTTP/2</h3>
            <p style="color: #cccccc;">
                HTTP/2 introduced a binary encoding format, making it more compact and efficient to parse. Its biggest feature was multiplexing, which allows multiple requests and responses to be sent in parallel over a single connection using "streams".
            </p>
            <p style="color: #cccccc;">
                This solved the head-of-line blocking at the HTTP level, but the problem still existed at the TCP level.
            </p>
            <ul>
                <li><a href="https://http.dev/2" target="_blank" style="color: #42a5f5;">http.dev/2</a></li>
                <li><a href="https://www.rfc-editor.org/rfc/rfc7540" target="_blank" style="color: #42a5f5;">RFC 7540</a></li>
            </ul>
        </div>
    </div>

    <div class="main-wrapper">
        <div class="main-box" style="background-color: #1f2a1f; border: 2px solid #66bb6a; border-radius: 8px;">
            <h3 id="http3" style="color: #66bb6a; margin-top: 0;">‚ú® HTTP/3</h3>
            <p style="color: #cccccc;">
                HTTP/3 improves upon HTTP/2 by using QUIC, a new transport protocol built on UDP. This finally eliminates head-of-line blocking entirely and allows for zero round-trip time (0-RTT) connection resumption.
            </p>
            <p style="color: #cccccc;">
                This could lead to seamless network switching in the future, for example, moving from Wi-Fi to cellular without a noticeable interruption.
            </p>
            <p style="color: #cccccc;">
                Browsers can discover HTTP/3 support in two main ways:
            </p>
            <ul style="color: #cccccc;">
                <li><strong>Alternative Service (<code>Alt-Svc</code>) header:</strong> The server can send an <code>Alt-Svc</code> header in an HTTP/1.1 or HTTP/2 response to indicate that HTTP/3 is available on a specific host and port.</li>
                <li><strong>HTTPS DNS record:</strong> A newer method involves a special <code>HTTPS</code> DNS record that signals HTTP/3 support directly, allowing a browser to connect using HTTP/3 on the very first request.</li>
            </ul>
            <ul>
                <li><a href="https://http.dev/3" target="_blank" style="color: #66bb6a;">http.dev/3</a></li>
                <li><a href="https://www.rfc-editor.org/rfc/rfc9114" target="_blank" style="color: #66bb6a;">RFC 9114</a></li>
            </ul>
        </div>
    </div>
</main>

<style>
.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #888888;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 2s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>

<script>
// Check for query parameter override first
const searchParams = new URLSearchParams(window.location.search);
const hasQueryOverride = searchParams.has('version');

// Function to display the HTTP version results
function displayHTTPVersion(httpVersion, props = {}) {
    console.log("displayHTTPVersion called with:", httpVersion);
    // Hide loading state
    document.getElementById("loading-state")?.setAttribute("hidden", true);
    console.log("Loading state should be hidden now");
    
    // Show dynamic indicator
    document.getElementById("dynamic-indicator")?.removeAttribute("hidden");

    switch (httpVersion) {
    case 'HTTP/1.0':
        document.getElementById("http10-header")?.removeAttribute("hidden");
        document.getElementById("cover-unknown")?.setAttribute("hidden", true);
        document.getElementById("cover-http10")?.removeAttribute("hidden");
        break;
    case 'HTTP/1.1':
        document.getElementById("http11-header")?.removeAttribute("hidden");
        document.getElementById("cover-unknown")?.setAttribute("hidden", true);
        document.getElementById("cover-http11")?.removeAttribute("hidden");
        break;
    case 'HTTP/2':
        document.getElementById("http2-header")?.removeAttribute("hidden");
        document.getElementById("cover-unknown")?.setAttribute("hidden", true);
        document.getElementById("cover-http2")?.removeAttribute("hidden");
        break;
    case 'HTTP/3':
        document.getElementById("http3-header")?.removeAttribute("hidden");
        document.getElementById("cover-unknown")?.setAttribute("hidden", true);
        document.getElementById("cover-http3")?.removeAttribute("hidden");
        break;
    default:
        document.getElementById("httpunknown-header")?.removeAttribute("hidden");
    }

    for (elem of document.getElementsByClassName("data-http-version")) {
        elem.innerHTML = httpVersion
    }

    // Only populate additional data if we have it (from actual HTTP detection)
    const filteredProps = Object.fromEntries(Object.entries(props).filter(([_, v]) => v != null));
    if (Object.keys(filteredProps).length > 0) {
        document.getElementById("clientDataWrapper").removeAttribute("hidden");
        document.getElementById("data-http-version").innerHTML = httpVersion;
        document.getElementById("data-asn").innerHTML = props.asnum;
        document.getElementById("data-city").innerHTML = props.city;
        document.getElementById("data-continent").innerHTML = props.continent;
        document.getElementById("data-country").innerHTML = props.country;
        document.getElementById("data-ip").innerHTML = props.ip;
        if (props.lat && props.lon) {
            document.getElementById("data-geo").innerHTML = `(${props.lat}, ${props.lon})`;
        }
        document.getElementById("data-postal-code").innerHTML = props.postalCode;
        document.getElementById("data-tz").innerHTML = props.tzName;
        document.getElementById("data-useragent").innerHTML = props.useragent;
    }
}

if (hasQueryOverride) {
    // If we have a query parameter, use it immediately without any HTTP detection
    console.log("Using query override:", searchParams.get('version'));
    const httpVersion = searchParams.get('version');
    displayHTTPVersion(httpVersion);
} else {
    // Only show loading state if we need to do actual HTTP detection
    console.log("No query override, showing loading state");
    document.getElementById("loading-state")?.removeAttribute("hidden");

    async function getHTTPVersion() {
        try {
            // Check if a custom URL is specified in query parameters
            const fetchUrl = `https://kmcd.dev/http/?t=${Date.now()}`;
            
            const resp = await fetch(fetchUrl);
            if (!resp.ok) {
                throw new Error(`resp status: ${resp.status}`);
            }
            // the server is configured to always return a header containing the http version used on the edge.
            console.log("HTTP response headers:", resp.headers);
            console.log("Available headers to JS:");
            for (let [key, value] of resp.headers.entries()) {
                console.log(`  ${key}: ${value}`);
            }
            return {
                httpVersion: resp.headers.get('x-kmcd-http-request-version'),
                asnum: resp.headers.get('x-kmcd-asnum'),
                city: resp.headers.get('x-kmcd-city'),
                continent: resp.headers.get('x-kmcd-continent'),
                country: resp.headers.get('x-kmcd-country'),
                ip: resp.headers.get('x-kmcd-ip'),
                lat: resp.headers.get('x-kmcd-lat'),
                lon: resp.headers.get('x-kmcd-lon'),
                postalCode: resp.headers.get('x-kmcd-postal-code'),
                region: resp.headers.get('x-kmcd-region'),
                regionCode: resp.headers.get('x-kmcd-region-code'),
                tzName: resp.headers.get('x-kmcd-tz-name'),
                useragent: resp.headers.get('x-kmcd-user-agent'),
            }
        } catch (error) {
            console.error(error.message);
            return {};
        }
    }

    async function getHTTPVersionWithRetries() {
        let props = {};
        for (let i = 0; i < 3; i++) {
            props = await getHTTPVersion();
            if (props.httpVersion === 'HTTP/3') {
                if (i > 0) {
                    document.getElementById("http3-retry-note")?.removeAttribute("hidden");
                }
                return props;
            }
            // wait a bit before retrying
            if (i < 2) {
                await new Promise(resolve => setTimeout(resolve, 200));
            }
        }
        return props;
    }

    getHTTPVersionWithRetries().then((props) => {
        const httpVersion = props.httpVersion || "???";
        console.log(props);
        displayHTTPVersion(httpVersion, props);
    });
}

</script>

        </main>
    </div>
</body>
</html>
{{- $renderHookName := "d2" -}}
{{- $inner := trim .Inner "\n\r" -}} {{/* The D2 code from the markdown block */}}
{{- $position := .Position -}} {{/* Source position for error messages */}}

{{- $apiEndpoint := "http://localhost:7001/render" -}} {{/* Your D2 rendering service endpoint */}}
{{- $opts := dict "method" "post" "body" $inner -}}
{{- /*
  Optional: If your API supports content negotiation via Accept header, you can add it.
  E.g., to prefer SVG but also accept PNG:
  $opts = merge $opts (dict "headers" (dict "Accept" "image/svg+xml, image/png;q=0.9"))
*/ -}}

{{- $fetchedResource := resources.GetRemote $apiEndpoint $opts }}

{{- with $fetchedResource }}
  {{- $diagramContent := .Content }}
  {{- if eq (len (trim $diagramContent " \n\r\t")) 0 }}
    {{- $errMsg := printf "Render hook %q: API at %s returned successful response but with empty content. Position: %s" $renderHookName $apiEndpoint $position }}
    {{- warnf $errMsg }}
  {{- else }}
    {{- $uniqueID := $inner | sha256 }}
    {{- $fileExtension := "svg" }}
    {{- with .MediaType }}
      {{- $fileExtension = .SubType }}
      {{- if eq $fileExtension "svg+xml" }}{{- $fileExtension = "svg" }}{{- end }}
    {{- end }}
    {{- $assetPath := printf "d2-diagrams/%s.%s" $uniqueID $fileExtension }}
    {{- $imageAsset := resources.FromString $assetPath $diagramContent }}
    <img src="{{ $imageAsset.RelPermalink }}" alt="D2 Diagram" loading="lazy" style="width:100%; height:auto; display:block;" />
  {{- end }}
{{- else }}
  {{- $errMsg := printf "Render hook %q: failed to fetch remote diagram from %s. Position: %s" $renderHookName $apiEndpoint $position }}
  {{- warnf $errMsg }}
{{- end }}